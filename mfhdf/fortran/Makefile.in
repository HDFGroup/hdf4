# Makefile for the FORTRAN interface to the Network CDF library
#
# $Id$

PROGRAM		= ftest
OS		= @OS@
FC		= @FC@
CPP_NETCDF	= -I../libsrc @HDF_INC@
CPPFLAGS	= $(CPP_NETCDF) @CPPFLAGS@
CFLAGS		= @CFLAGS@
FFLAGS		= @FFLAGS@
HDF_LIB         = @HDF_LIB@
GARBAGE		= $(PROGRAM) test.nc copy.nc netcdf.inc jackets.c \
		  $(PROGRAM).f test*.hdf hdftest hdfout.new
HEADERS		= netcdf.inc
MANIFEST	= $(PROGRAM).src Makefile.in README aix.m4 common.inc \
		  common.m4 depend descrip.mms fortc fortc1.sed \
		  fortc2.sed hpux.m4 irix.m4 jackets.src msoft.m4 msoft.mk \
		  next.m4 osf.m4 sunos.m4 ultrix.m4 unicos.m4 vax-ultrix.m4 \
		  vms.m4 \
		  msoft/NOTES msoft/fslen.asm msoft/ftest.for \
		  msoft/jackets.c msoft/msoft.int \
		  msoft/netcdf.inc \
		  vms/ftest.for \
		  vms/ftest.m4 \
		  vms/jackets.c \
		  vms/make.com \
		  vms/netcdf.inc \
		  mfsdf.c mfsdff.f hdftest.f

LIBOBJS		= jackets.o mfsdf.o mfsdff.o
LIBNAME		= netcdf
REMOTE_LIBRARY	= ../libsrc/lib$(LIBNAME).a
OBJS		= $(PROGRAM).o $(LIBOBJS) 
LD_XDR		= @LD_XDR@
LD_NETCDF	= -L../libsrc -lnetcdf
LIBS		= $(LD_NETCDF) $(LD_XDR) $(HDF_LIB)
prefix		= ../../..

all::		FORCE
	@case "$(FC)" in \
	NONE*|none*) \
	    echo 1>&2 "\`$@' not made because no FORTRAN compiler";; \
	*) \
	    $(MAKE) netcdf.inc $(REMOTE_LIBRARY);; \
	esac

test:		FORCE
	@case "$(FC)" in \
	NONE*|none*) \
	    echo 1>&2 "\`$@' not made because no FORTRAN compiler";; \
	*) \
	    $(MAKE) $(MFLAGS) $(PROGRAM); \
	    $(MAKE) $(MFLAGS) hdftest; \
	    ./$(PROGRAM);; \
	esac

install::	FORCE
	@case "$(FC)" in \
	NONE*|none*) \
	    echo 1>&2 "\`$@' not made because no FORTRAN compiler";; \
	*) \
	    $(MAKE) installed_headers;; \
	esac

$(PROGRAM):	$(REMOTE_LIBRARY)

include ../port/master.mk

jackets.c:	fortc1.sed fortc2.sed common.m4 jackets.src $(OS).m4
	./fortc -L . -O $(OS) jackets.src > $@

netcdf.inc:	common.inc fortc1.sed fortc2.sed common.m4 $(OS).m4
	./fortc -L . -O $(OS) common.inc > $@

$(PROGRAM).f:	fortc1.sed fortc2.sed common.m4 $(PROGRAM).src $(OS).m4
	./fortc -L . -O $(OS) $(PROGRAM).src > $@

hdftest:        hdftest.f $(LIBRARY)
	$(FC) -g hdftest.f $(LIBS) -o $@
	./hdftest > hdfout.new
	@cmd="diff hdfout.new hdftst.sav"; \
	    echo $$cmd; \
	    if $$cmd; then \
		echo "*** HDF passes FORTRAN test ***"; \
	    else \
		echo "*** HDF fails FORTRAN test ***"; \
		echo "The above differences are OK if small"; \
		exit 0; \
	    fi

$(PROGRAM).o:	netcdf.inc
jackets.o:	../libsrc/netcdf.h

### Everything after the following line might be overwritten ###
### DO NOT DELETE THIS LINE.  make depend DEPENDS ON IT ###
include depend
